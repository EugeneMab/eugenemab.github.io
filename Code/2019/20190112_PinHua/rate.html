<html>
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<script src="prepare.js">
</script>
<script>
var precision = 6;
var sample = "背影"
	+ "我与父亲不相见已二年余了，我最不能忘记的是他的背影。"
	+ "那年冬天，祖母死了，父亲的差使也交卸了，正是祸不单行的日子。我从北京到徐州，打算跟着父亲奔丧回家。到徐州见着父亲，看见满院狼藉的东西，又想起祖母，不禁簌簌地流下眼泪。父亲说：“事已如此，不必难过，好在天无绝人之路！”"
	+ "回家变卖典质，父亲还了亏空；又借钱办了丧事。这些日子，家中光景很是惨澹，一半为了丧事，一半为了父亲赋闲。丧事完毕，父亲要到南京谋事，我也要回北京念书，我们便同行。"
	+ "到南京时，有朋友约去游逛，勾留了一日；第二日上午便须渡江到浦口，下午上车北去。父亲因为事忙，本已说定不送我，叫旅馆里一个熟识的茶房陪我同去。他再三嘱咐茶房，甚是仔细。但他终于不放心，怕茶房不妥帖；颇踌躇了一会。其实我那年已二十岁，北京已来往过两三次，是没有什么要紧的了。他踌躇了一会，终于决定还是自己送我去。我再三劝他不必去；他只说：“不要紧，他们去不好！”"
	+ "我们过了江，进了车站。我买票，他忙着照看行李。行李太多，得向脚夫行些小费才可过去。他便又忙着和他们讲价钱。我那时真是聪明过分，总觉他说话不大漂亮，非自己插嘴不可，但他终于讲定了价钱；就送我上车。他给我拣定了靠车门的一张椅子；我将他给我做的紫毛大衣铺好座位。他嘱我路上小心，夜里要警醒些，不要受凉。又嘱托茶房好好照应我。我心里暗笑他的迂；他们只认得钱，托他们只是白托！而且我这样大年纪的人，难道还不能料理自己么？我现在想想，我那时真是太聪明了。"
	+ "我说道：“爸爸，你走吧。”他望车外看了看，说：“我买几个橘子去。你就在此地，不要走动。”我看那边月台的栅栏外有几个卖东西的等着顾客。走到那边月台，须穿过铁道，须跳下去又爬上去。父亲是一个胖子，走过去自然要费事些。我本来要去的，他不肯，只好让他去。我看见他戴着黑布小帽，穿着黑布大马褂，深青布棉袍，蹒跚地走到铁道边，慢慢探身下去，尚不大难。可是他穿过铁道，要爬上那边月台，就不容易了。他用两手攀着上面，两脚再向上缩；他肥胖的身子向左微倾，显出努力的样子。这时我看见他的背影，我的泪很快地流下来了。我赶紧拭干了泪。怕他看见，也怕别人看见。我再向外看时，他已抱了朱红的橘子往回走了。过铁道时，他先将橘子散放在地上，自己慢慢爬下，再抱起橘子走。到这边时，我赶紧去搀他。他和我走到车上，将橘子一股脑儿放在我的皮大衣上。于是扑扑衣上的泥土，心里很轻松似的。过一会儿说：“我走了，到那边来信！”我望着他走出去。他走了几步，回过头看见我，说：“进去吧，里边没人。”等他的背影混入来来往往的人里，再找不着了，我便进来坐下，我的眼泪又来了。"
	+ "近几年来，父亲和我都是东奔西走，家中光景是一日不如一日。他少年出外谋生，独力支持，做了许多大事。哪知老境却如此颓唐！他触目伤怀，自然情不能自已。情郁于中，自然要发之于外；家庭琐屑便往往触他之怒。他待我渐渐不同往日。但最近两年不见，他终于忘却我的不好，只是惦记着我，惦记着他的儿子。我北来后，他写了一信给我，信中说道：“我身体平安，惟膀子疼痛厉害，举箸提笔，诸多不便，大约大去之期不远矣。”我读到此处，在晶莹的泪光中，又看见那肥胖的、青布棉袍黑布马褂的背影。唉！我不知何时再能与他相见！ ";
function summarize(maxConflictInfos) {
	var output = "";
	for (var row = 0 ;row < maxConflictInfos.length; row++) {
		var entry = maxConflictInfos[row];
		output += " " + entry.e + ":";
		var characterList = entry.c;
		for (var index = 0; index < characterList.length; index++) {
			output += characterList[index].g;
		}
	}
	return output;
}
var staticUseFull = false;
function dictMake(dictionary, key, creater) {
	var found = dictionary[key];
	if (found) {
		return found;
	}
	var created = creater();
	dictionary[key] = created;
	return created;
}
function once(
		logOutputs,
		rateOutputs,
		sampleOutputs,
		name,
		characterToEncode,
		mapOutputs,
		tableOutputs,
		suffixOutputs,
		characterToExplain) {
	if (mapOutputs) {
		mapOutputs.push("var map = { \"\": [\"\",\"\"]");
	}
	if (!mapOutputs && !staticUseFull) {
		return;
	}
	rateOutputs.push("____");
	rateOutputs.push("Name: " + name);
	var glyphToEncode = {};
	for (var level = 1; level <= 3; level++) {
		var encodeToInfo = {};
		for (var index = 0; index < data_prepared.length; index++) {
			var character = data_prepared[index];
			if (character.l > level) {
				continue;
			}
			var encode = characterToEncode(character);
			if (level == 3) {
				glyphToEncode[character.g] = encode;
			}
			var info = encodeToInfo[encode];
			if (!info) {
				encodeToInfo[encode] = {
					// encode
					e: encode,
					// characters
					c: [
						character
					]
				};
				continue;
			}
			info.c.push(character);
		}
		var characterCount = 0;
		var encodeCount = 0;
		var conflictEncodeCount = 0;
		var maxConflict = 0;
		var maxConflictInfos = [];
		for (var encode in encodeToInfo) {
			if (!encodeToInfo.hasOwnProperty(encode)) {
				continue;
			}
			var info = encodeToInfo[encode];
			characterCount += info.c.length;
			encodeCount++;
			var conflict = info.c.length - 1;
			if (conflict == 0) {
				continue;
			}
			conflictEncodeCount++;
			if (conflict < maxConflict) {
				continue;
			}
			if (conflict == maxConflict) {
				maxConflictInfos.push(info);
				continue;
			}
			maxConflict = conflict;
			maxConflictInfos = [info];
		}
		var averageConflict = characterCount / encodeCount - 1;
		var conflictEncodeRate = conflictEncodeCount / encodeCount;
		rateOutputs.push("Level: "
			+ level
			+ " chr="
			+ characterCount
			+ " enc="
			+ encodeCount
			+ " avg="
			+ averageConflict.toPrecision(precision)
			+ " cec="
			+ conflictEncodeCount
			+ " cer="
			+ conflictEncodeRate.toPrecision(precision)
			+ " max="
			+ maxConflict
			+ summarize(maxConflictInfos));
		logOutputs.push("Level: "
			+ level
			+ " character="
			+ characterCount
			+ " encode="
			+ encodeCount
			+ " averageConflict="
			+ averageConflict
			+ " conflictEncodeCount="
			+ conflictEncodeCount
			+ " conflictEncodeRate="
			+ conflictEncodeRate
			+ " maxConflict="
			+ maxConflict
			+ " maxConflictInfos="
			+ JSON.stringify(maxConflictInfos));
	}
	sampleOutputs.push("____");
	sampleOutputs.push("Name: " + name);
	var converted = "";
	for (var position = 0; position < sample.length; position++) {
		var glyph = sample.charAt(position);
		if (glyph == "\r" || glyph == "\n") {
			converted += glyph;
			continue;
		}
		var encode = glyphToEncode[glyph];
		if (!encode) {
			converted += glyph + " ";
			continue;
		}
		converted += encode + " ";
		if (converted.length < 100) {
			continue;
		}
		sampleOutputs.push(converted);
		converted = "";
	}
	sampleOutputs.push(converted);
	if (mapOutputs) {
		var suffixToEncodeToLine = {};
		for (var index = 0; index < data_prepared.length; index++) {
			// map
			var character = data_prepared[index];
			var encode = glyphToEncode[character.g];
			var explain = characterToExplain(character);
			var info = encodeToInfo[encode];
			var levelToSegment = ["", "", "", ""];
			for (var peer = 0; peer < info.c.length; peer++) {
				var peerCharacter = info.c[peer];
				levelToSegment[peerCharacter.l] += peerCharacter.g;
			}
			var detail = explain + levelToSegment.join(".");
			mapOutputs.push(",\"" + character.g + "\":" + JSON.stringify([encode, detail]));
			// table
			tableOutputs.push(character.g + "," + encode + "," + detail);
			// suffix
			if (levelToSegment[1] == "") {
				continue;
			}
			var suffix = encode.substr(encode.length - 2, 2);
			var encodeToLine = dictMake(suffixToEncodeToLine, suffix, function() { return {}; });
			dictMake(encodeToLine, encode, function() { return encode.substr(0, encode.length - 2) + "," + levelToSegment[1]; });
		}
		// table
		mapOutputs.push("};");
		// suffix
		for (var suffix in suffixToEncodeToLine) {
			if (!suffixToEncodeToLine.hasOwnProperty(suffix)) {
				continue;
			}
			var builder = suffix;
			var encodeToLine = suffixToEncodeToLine[suffix];
			for (var encode in encodeToLine) {
				if (!encodeToLine.hasOwnProperty(encode)) {
					continue;
				}
				var line = encodeToLine[encode];
				builder += " " + line;
			}
			suffixOutputs.push(builder);
		}
		suffixOutputs.sort();
	}
}
function select(writes, head, tail) {
	var lengthMinusTail = writes.length - tail;
	var selected = "";
	for (var index = 0; index < writes.length; index++) {
		if (index < head || lengthMinusTail <= index) {
			selected += writes.charAt(index);
		}
	}
	return selected;
}
var writesToLetter = {
	"--"   : "g", "-|"   : "f", "-/"   : "d", "-\\"  : "s", "-~"   : "a", "- "   : "g",
	"|-"   : "h", "||"   : "j", "|/"   : "k", "|\\"  : "l", "|~"   : "m", "| "   : "h",
	"/-"   : "t", "/|"   : "r", "//"   : "e", "/\\"  : "w", "/~"   : "q", "/ "   : "t",
	"\\-"  : "y", "\\|"  : "u", "\\/"  : "i", "\\\\" : "o", "\\~"  : "p", "\\ "  : "y",
	"~-"   : "n", "~|"   : "b", "~/"   : "v", "~\\"  : "c", "~~"   : "x", "~ "   : "n",
	"  "   : "z"
};
function letter(writes, head, tail, count) {
	var selected = select(writes, head, tail);
	var letters = "";
	for (var index = 0; index < count; index++) {
		var one = index * 2;
		var two = one + 1;
		letters += writesToLetter[(one < selected.length ? selected.charAt(one) : " ") + (two < selected.length ? selected.charAt(two) : " ")];
	}
	return letters;
}
function init() {
	var logOutputs = [];
	logOutputs.push("data_prepared.length=" + data_prepared.length);

	var rateOutputs = [];
	var sampleOutputs = [];
	var mapOutputs = [];
	var tableOutputs = [];
	var suffixOutputs = [];

	// once(logOutputs, rateOutputs, sampleOutputs, "No tone, no stroke"     , function(character) { return character.b; });
	// once(logOutputs, rateOutputs, sampleOutputs, "No tone, head 1"        , function(character) { return character.b + select(character.v, 1, 0); });
	// once(logOutputs, rateOutputs, sampleOutputs, "No tone, head 2"        , function(character) { return character.b + select(character.v, 2, 0); });
	// once(logOutputs, rateOutputs, sampleOutputs, "No tone, head 1 tail 1" , function(character) { return character.b + select(character.v, 1, 1); });
	// once(logOutputs, rateOutputs, sampleOutputs, "No tone, head 3"        , function(character) { return character.b + select(character.v, 3, 0); });
	// once(logOutputs, rateOutputs, sampleOutputs, "No tone, head 2, tail 1", function(character) { return character.b + select(character.v, 2, 1); });
	// once(logOutputs, rateOutputs, sampleOutputs, "No tone, head 4"        , function(character) { return character.b + select(character.v, 4, 0); });
	// once(logOutputs, rateOutputs, sampleOutputs, "No tone, head 3, tail 1", function(character) { return character.b + select(character.v, 3, 1); });
	// once(logOutputs, rateOutputs, sampleOutputs, "No tone, head 2, tail 2", function(character) { return character.b + select(character.v, 2, 2); });
	// once(logOutputs, rateOutputs, sampleOutputs, "No tone, head 5"        , function(character) { return character.b + select(character.v, 5, 0); });
	// once(logOutputs, rateOutputs, sampleOutputs, "No tone, head 4, tail 1", function(character) { return character.b + select(character.v, 4, 1); });
	// once(logOutputs, rateOutputs, sampleOutputs, "No tone, head 3, tail 2", function(character) { return character.b + select(character.v, 3, 2); });
	// once(logOutputs, rateOutputs, sampleOutputs, "No tone, full stroke"   , function(character) { return character.b + character.v; });
	// once(logOutputs, rateOutputs, sampleOutputs, "Tone, no stroke"        , function(character) { return character.b + character.t; });
	// once(logOutputs, rateOutputs, sampleOutputs, "Tone, head 1"           , function(character) { return character.b + character.t + select(character.v, 1, 0); });
	// once(logOutputs, rateOutputs, sampleOutputs, "Tone, head 2"           , function(character) { return character.b + character.t + select(character.v, 2, 0); });
	// once(logOutputs, rateOutputs, sampleOutputs, "Tone, head 1 tail 1"    , function(character) { return character.b + character.t + select(character.v, 1, 1); });
	// once(logOutputs, rateOutputs, sampleOutputs, "Tone, head 3"           , function(character) { return character.b + character.t + select(character.v, 3, 0); });
	// once(logOutputs, rateOutputs, sampleOutputs, "Tone, head 2, tail 1"   , function(character) { return character.b + character.t + select(character.v, 2, 1); });
	// once(logOutputs, rateOutputs, sampleOutputs, "Tone, head 4"           , function(character) { return character.b + character.t + select(character.v, 4, 0); });
	// once(logOutputs, rateOutputs, sampleOutputs, "Tone, head 3, tail 1"   , function(character) { return character.b + character.t + select(character.v, 3, 1); });
	// once(logOutputs, rateOutputs, sampleOutputs, "Tone, head 2, tail 2"   , function(character) { return character.b + character.t + select(character.v, 2, 2); });
	// once(logOutputs, rateOutputs, sampleOutputs, "Tone, full stroke"      , function(character) { return character.b + character.t + character.v; });

	once(logOutputs, rateOutputs, sampleOutputs, "Extra 0, No tone, no stroke"     , function(character) { return character.b; });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 1, No tone, head 1"        , function(character) { return character.b + select(character.v, 1, 0); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 1, Tone, no stroke"        , function(character) { return character.b + character.t; });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 2, No tone, head 2"        , function(character) { return character.b + select(character.v, 2, 0); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 2, No tone, head 1 tail 1" , function(character) { return character.b + select(character.v, 1, 1); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 2, Tone, head 1"           , function(character) { return character.b + character.t + select(character.v, 1, 0); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 3, No tone, head 3"        , function(character) { return character.b + select(character.v, 3, 0); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 3, No tone, head 2, tail 1", function(character) { return character.b + select(character.v, 2, 1); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 3, Tone, head 2"           , function(character) { return character.b + character.t + select(character.v, 2, 0); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 3, Tone, head 1 tail 1"    , function(character) { return character.b + character.t + select(character.v, 1, 1); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 4, No tone, head 4"        , function(character) { return character.b + select(character.v, 4, 0); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 4, No tone, head 4, letter", function(character) { return character.b + letter(character.v, 4, 0, 2); }, mapOutputs, tableOutputs, suffixOutputs, function(character) { return select(character.v, 4, 0); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 4, No tone, head 3, tail 1", function(character) { return character.b + select(character.v, 3, 1); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 4, No tone, head 2, tail 2", function(character) { return character.b + select(character.v, 2, 2); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 4, Tone, head 3"           , function(character) { return character.b + character.t + select(character.v, 3, 0); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 4, Tone, head 2, tail 1"   , function(character) { return character.b + character.t + select(character.v, 2, 1); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 5, No tone, head 5"        , function(character) { return character.b + select(character.v, 5, 0); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 5, No tone, head 4, tail 1", function(character) { return character.b + select(character.v, 4, 1); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 5, No tone, head 3, tail 2", function(character) { return character.b + select(character.v, 3, 2); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 5, Tone, head 4"           , function(character) { return character.b + character.t + select(character.v, 4, 0); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 5, Tone, head 3, tail 1"   , function(character) { return character.b + character.t + select(character.v, 3, 1); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra 5, Tone, head 2, tail 2"   , function(character) { return character.b + character.t + select(character.v, 2, 2); });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra A, No tone, full stroke"   , function(character) { return character.b + character.v; });
	once(logOutputs, rateOutputs, sampleOutputs, "Extra B, Tone, full stroke"      , function(character) { return character.b + character.t + character.v; });

	document.getElementById("rate").value = rateOutputs.join("\r\n");
	document.getElementById("log").value = logOutputs.join("\r\n");
	document.getElementById("sample").value = sampleOutputs.join("\r\n");
	document.getElementById("map").value = mapOutputs.join("\r\n");
	document.getElementById("table").value = tableOutputs.join("\r\n");
	document.getElementById("suffix").value = suffixOutputs.join("\r\n");
}
function goFull() {
	staticUseFull = true;
	init();
}
</script>
<body style="font-family: Courier; font-size: 24px;" onload="init()">
<input type="button" value="Full" onclick="goFull()"/>
<br/>
<textarea id="rate" cols="180" rows="25" style="font-family: 宋体, SimSun, Courier; font-size: 24px;">
</textarea>
<br/>
<textarea id="log" cols="180" rows="25" style="font-family: 宋体, SimSun, Courier; font-size: 24px;">
</textarea>
<textarea id="sample" cols="180" rows="25" style="font-family: 宋体, SimSun, Courier; font-size: 24px;">
</textarea>
<textarea id="map" cols="180" rows="25" style="font-family: 宋体, SimSun, Courier; font-size: 24px;">
</textarea>
<textarea id="table" cols="180" rows="25" style="font-family: 宋体, SimSun, Courier; font-size: 24px;">
</textarea>
<textarea id="suffix" cols="180" rows="25" style="font-family: 宋体, SimSun, Courier; font-size: 24px;">
</textarea>
<br/>
</body>
</html>
